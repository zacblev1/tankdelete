---
phase: 03-core-gameplay
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/Scene/PortalCollision.tsx
  - src/components/HUD/Minimap.tsx
  - src/components/Scene/FolderPortal.tsx
  - src/components/Scene/BackPortal.tsx
  - src/App.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "User can drive tank through a folder portal to enter that directory and scene reloads"
    - "User can drive tank through back portal to navigate to parent directory"
    - "Tank spawns near the back portal after entering a new directory"
    - "Minimap displays current directory layout with dots for files/folders and player position"
  artifacts:
    - path: "src/components/Scene/PortalCollision.tsx"
      provides: "Drive-through collision detection between tank and portals"
      contains: "intersectsBox"
    - path: "src/components/HUD/Minimap.tsx"
      provides: "Radar-style circular minimap in bottom-left corner"
      contains: "canvas"
  key_links:
    - from: "src/components/Scene/PortalCollision.tsx"
      to: "src/App.tsx"
      via: "onEnterFolder and onEnterBackPortal callbacks trigger directory navigation"
      pattern: "navigateToDirectory"
    - from: "src/components/HUD/Minimap.tsx"
      to: "src/App.tsx"
      via: "Receives tank position and block positions for radar rendering"
      pattern: "tankPosition"
---

<objective>
Implement drive-through portal navigation (tank collides with portal to enter directory) and radar-style minimap HUD showing files, folders, and player position.

Purpose: Portal navigation replaces click-to-enter with immersive drive-through gameplay. Minimap provides spatial awareness in large directories.
Output: PortalCollision.tsx, Minimap.tsx, updated portal components and App.tsx.
</objective>

<execution_context>
@/Users/zacharyblevins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zacharyblevins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-gameplay/03-RESEARCH.md
@.planning/phases/03-core-gameplay/03-01-SUMMARY.md
@src/App.tsx
@src/components/Scene/FolderPortal.tsx
@src/components/Scene/BackPortal.tsx
@src/hooks/useFileBlocks.ts
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement drive-through portal collision detection and navigation</name>
  <files>src/components/Scene/PortalCollision.tsx, src/components/Scene/FolderPortal.tsx, src/components/Scene/BackPortal.tsx, src/App.tsx</files>
  <action>
**PortalCollision.tsx:**
Create a component that checks tank-portal bounding box collisions each frame.

Props:
```typescript
interface PortalCollisionProps {
  tankRef: React.RefObject<THREE.Group>;
  folderPortals: Array<{ path: string; position: [number, number, number]; scale: number }>;
  backPortalPosition: [number, number, number] | null;
  onEnterFolder: (folderPath: string) => void;
  onEnterBackPortal: () => void;
}
```

Implementation:
- Use useFrame to check every frame (Box3 checks are cheap, no perf concern)
- Pre-allocate reusable Box3 objects with useMemo: `tankBox`, `portalBox`
- For each folder portal: compute portal bounding box from its position and archway dimensions (width ~ 2 * scale, height ~ 2.5 * scale, depth ~ 0.5)
- Compute tank bounding box from tankRef world position (approximate as Box3 with size ~1.2 x 0.5 x 1.8 centered on tank)
- If `tankBox.intersectsBox(portalBox)` → trigger navigation
- CRITICAL: Add cooldown to prevent multiple triggers. Use `useRef(0)` for lastNavigationTime. Check `clock.elapsedTime - lastNavigationTime.current > 1.0` before allowing navigation. Set lastNavigationTime on trigger.
- For back portal: same logic but with fixed position [0, 0.5, -15] and fixed scale 0.8
- Returns null (invisible collision checker)

**FolderPortal.tsx updates:**
- Remove onClick handler from the invisible clickable mesh — navigation is now via drive-through, not clicking
- Keep the mesh for visual fill (emissive glow) but remove click/hover pointer events
- OR: keep onClick as fallback but remove pointer cursor change. Actually, per user decision "Drive straight through to enter — no confirmation prompt or hover action required", remove click navigation entirely. The portal is drive-through only.
- Add a `portalRef` using useRef on the main group so PortalCollision can read world position if needed. OR just pass position data directly to PortalCollision (simpler).

**BackPortal.tsx updates:**
- Same as FolderPortal: remove onClick from mesh, navigation is drive-through only
- Keep visual rendering unchanged (green archway with labels)

**App.tsx updates:**
- Add PortalCollision component inside Scene, passing:
  - tankRef
  - Array of folder portal data (path, position, scale) derived from existing folder rendering logic
  - Back portal position (or null if at root)
  - onEnterFolder: calls navigateToDirectory(folderPath)
  - onEnterBackPortal: calls navigateUp()
- When navigateToDirectory is called (from portal entry):
  - Scene reloads with new directory contents (existing scanDirectory logic handles this)
  - Tank should spawn near the back portal position: modify tank starting position to [0, 0, -12] (near the back portal at z=-15) so the user is oriented looking forward into the new directory
  - Reset tank rotation to face forward (rotation.y = 0)
  - Clear marked files on directory change (simple mental model, avoid stale state per research recommendation)
- Add a `tankStartPosition` state that resets to [0, 0, -12] on each directory navigation. Pass to Tank component as `initialPosition` prop. Tank reads it on mount/when it changes.
  </action>
  <verify>
Run `cd /Users/zacharyblevins/Desktop/tankdelete && npx tsc --noEmit` — no type errors.
Verify PortalCollision.tsx exports component with useFrame collision checking.
Verify FolderPortal.tsx no longer has onClick/onPointerOver on the interaction mesh.
Verify BackPortal.tsx no longer has onClick on the interaction mesh.
Verify App.tsx includes PortalCollision and passes navigation callbacks.
  </verify>
  <done>Driving tank through a folder portal triggers navigateToDirectory and scene reloads with new directory. Driving through back portal triggers navigateUp. Tank spawns near back portal position facing forward in new directories. 1-second cooldown prevents multiple triggers. Marked files cleared on navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Create radar-style circular minimap HUD</name>
  <files>src/components/HUD/Minimap.tsx, src/App.tsx, src/App.css</files>
  <action>
**Minimap.tsx:**
Create an HTML Canvas-based radar minimap as a React component (NOT a 3D component).

Props:
```typescript
interface MinimapProps {
  tankPosition: [number, number, number];
  tankRotation: number; // Y rotation in radians
  fileBlocks: Array<{ position: [number, number, number]; color: string; isMarked?: boolean }>;
  folderPortals: Array<{ position: [number, number, number] }>;
  backPortalPosition: [number, number, number] | null;
}
```

Implementation:
- Render an HTML `<canvas>` element with fixed size 160x160px
- Position in bottom-left corner: `position: fixed; bottom: 20px; left: 20px; z-index: 50`
- Style: circular clip (border-radius: 50%), dark semi-transparent background (rgba(5, 5, 16, 0.85)), cyan border 2px solid #00ffff
- Radar radius: 30 units of world space mapped to 70px canvas radius
- Drawing (use useEffect + requestAnimationFrame or a separate update interval at ~15fps to avoid overhead):
  1. Clear canvas and draw dark circle background
  2. Draw faint concentric ring guides (2-3 rings) in dim cyan
  3. Draw rotating sweep line (optional — classic radar feel, use clock time to rotate)
  4. For each file block: compute relative position from tank, rotate by negative tank Y rotation (so minimap north = tank forward), scale to canvas coords. Draw as small colored dot (3px radius) using block's category color. If marked, draw as red dot.
  5. For each folder portal: draw as magenta diamond/square (4px)
  6. For back portal: draw as green triangle (4px)
  7. Draw player position at center as bright white/cyan triangle pointing up (tank forward direction)
- Use `useRef<HTMLCanvasElement>` for canvas ref
- Use `useEffect` to redraw when props change, OR use `requestAnimationFrame` for smooth updates
- Performance: Only redraw on position changes. Use `useRef` to track last drawn positions and skip if unchanged. With ~15fps update rate, this is negligible overhead.

**App.tsx updates:**
- Import Minimap from components/HUD/Minimap
- Track tank position and rotation in App state via a callback from Tank: `onPositionUpdate: (position: [number, number, number], rotation: number) => void`
- Actually, to avoid re-renders on every frame, use refs. Have Tank call a callback on each frame via useFrame, but store in ref not state. Then Minimap reads from the ref at its own update rate.
- Better approach: Create a shared ref object `tankStateRef = useRef({ position: [0, 0, 0], rotation: 0 })`. Pass to Tank (writes to it each frame) and Minimap (reads from it at canvas draw rate).
- Pass file block positions and folder portal positions to Minimap (these are stable, only change on directory navigation)
- Render Minimap component OUTSIDE the Scene (it's HTML, not 3D), alongside Crosshair and HUD

**App.css updates:**
- Add minimap positioning styles if not using inline styles in Minimap.tsx
  </action>
  <verify>
Run `cd /Users/zacharyblevins/Desktop/tankdelete && npx tsc --noEmit` — no type errors.
Run `cd /Users/zacharyblevins/Desktop/tankdelete && npm run build` — build succeeds.
Verify Minimap.tsx exports Minimap component with canvas rendering.
Verify App.tsx renders Minimap with tank position and file/folder data.
  </verify>
  <done>Circular radar-style minimap renders in bottom-left corner. Shows colored dots for files (matching category colors), magenta squares for folder portals, green triangle for back portal, and bright cyan triangle at center for player. Minimap rotates with tank orientation so forward is always up. Updates at smooth rate without impacting 3D performance.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. PortalCollision.tsx checks bounding box intersections with cooldown
4. FolderPortal.tsx and BackPortal.tsx no longer use onClick for navigation
5. Tank spawns at [0, 0, -12] (near back portal) when entering new directory
6. Minimap.tsx renders HTML canvas with radar visualization
7. Minimap shows file dots, folder portals, back portal, and player indicator
8. Minimap positioned in bottom-left corner with Tron styling
9. Directory navigation clears marked files
</verification>

<success_criteria>
- Driving tank through folder portal instantly loads new directory (scene reloads)
- Driving through back portal navigates to parent directory
- Tank spawns near back portal in new directory, facing forward
- Navigation has 1-second cooldown to prevent rapid triggers
- Circular minimap visible in bottom-left corner
- Minimap shows colored dots for files matching their category colors
- Minimap shows distinct markers for folder portals and back portal
- Player indicator at minimap center, oriented with tank direction
- Marked files appear as red dots on minimap
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-gameplay/03-03-SUMMARY.md`
</output>
