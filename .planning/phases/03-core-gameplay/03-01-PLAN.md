---
phase: 03-core-gameplay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Scene/Tank.tsx
  - src/components/Scene/CameraRig.tsx
  - src/components/Scene/Crosshair.tsx
  - src/components/Scene/Scene.tsx
  - src/lib/constants.ts
  - src/App.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "User can move tank forward/backward with W/S keys on the grid"
    - "User can rotate tank body left/right with A/D keys"
    - "User can aim turret independently with mouse movement"
    - "Third-person camera follows behind and above the tank smoothly"
    - "Crosshair reticle is visible at screen center for aiming"
  artifacts:
    - path: "src/components/Scene/Tank.tsx"
      provides: "Composite tank with body + independent turret, WASD movement, mouse aim"
      contains: "useKeyboardControls"
    - path: "src/components/Scene/CameraRig.tsx"
      provides: "Third-person camera follow with turret aim offset"
      contains: "useFrame"
    - path: "src/components/Scene/Crosshair.tsx"
      provides: "Center-screen aiming reticle"
    - path: "src/lib/constants.ts"
      provides: "Gameplay tuning constants (speeds, camera offsets)"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/Scene/Tank.tsx"
      via: "KeyboardControls wrapper and Tank component in Scene"
      pattern: "KeyboardControls.*map"
    - from: "src/components/Scene/CameraRig.tsx"
      to: "src/components/Scene/Tank.tsx"
      via: "Shared ref to tank group for camera tracking"
      pattern: "tankRef"
---

<objective>
Create a drivable Tron-style tank with classic tank controls (A/D rotate body, W/S move forward/back), independent mouse-controlled turret, smooth third-person camera, and crosshair reticle.

Purpose: Establishes the player character and movement system — the foundation all other gameplay (shooting, navigation, deletion) builds on.
Output: Tank.tsx, CameraRig.tsx, Crosshair.tsx, constants.ts, updated Scene.tsx and App.tsx with KeyboardControls integration.
</objective>

<execution_context>
@/Users/zacharyblevins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zacharyblevins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-gameplay/03-RESEARCH.md
@.planning/phases/02-3d-visualization/02-02-SUMMARY.md
@src/App.tsx
@src/components/Scene/Scene.tsx
@src/lib/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Tank component with WASD body controls and mouse turret aim</name>
  <files>src/components/Scene/Tank.tsx, src/lib/constants.ts</files>
  <action>
Create `src/lib/constants.ts` with gameplay tuning values:
- `TANK_SPEED = 8` (units/second, instant movement per user decision — no acceleration)
- `TANK_ROTATION_SPEED = 2.5` (radians/second)
- `PROJECTILE_SPEED = 25` (units/second, for Plan 02)
- `PROJECTILE_MAX_LIFETIME = 3.0` (seconds)
- `CAMERA_OFFSET = [0, 5, 8]` (behind and above)
- `CAMERA_LERP_SPEED = 6` (smoothing factor)
- `CAMERA_LOOK_LERP_SPEED = 10`
- `TURRET_AIM_BLEND = 0.3` (camera shifts 30% toward turret aim direction)

Create `src/components/Scene/Tank.tsx` as a composite group component:

**Tank body (outer group with tankRef):**
- Classic tank controls: A/D rotate body on Y axis, W/S move forward/back relative to body facing direction
- Use `useKeyboardControls` from drei with `get()` method for transient reads (NOT reactive subscriptions — avoid re-renders)
- Movement is instant (no acceleration/momentum per user decision): if W pressed, immediately move at TANK_SPEED * delta
- Normalize direction vector to prevent diagonal speed boost
- Pre-allocate reusable Vector3 with `useMemo(() => new Vector3(), [])` to avoid GC pressure in useFrame
- Visual: Tron light tank — low-poly wireframe with neon cyan edges. Build from:
  - Main chassis: `EdgesGeometry` of `BoxGeometry(1.2, 0.4, 1.8)` with cyan lineBasicMaterial (toneMapped=false)
  - Transparent face fill: same box with meshStandardMaterial, emissive cyan, opacity 0.1
  - Add treads: two narrow boxes on sides `BoxGeometry(0.15, 0.3, 1.6)` at x = +/- 0.6
  - Position tank so bottom sits at y=0 (add y offset of 0.2 to entire group)

**Turret (inner group with turretRef):**
- Positioned atop body at `[0, 0.4, 0]`
- Independent Y-axis rotation controlled by mouse
- Use `useThree()` to get `camera` and `pointer`, create Raycaster + ground Plane (y=0) to find mouse-to-world intersection
- `turretRef.current.lookAt(intersection.x, turretRef.current.position.y, intersection.z)` — but lookAt must account for parent (tank body) world transform. Use `turretRef.current.worldToLocal(intersection.clone())` then compute local rotation, OR detach turret world rotation by applying inverse of body rotation.
- Visual: Octagonal turret base `CylinderGeometry(0.35, 0.35, 0.25, 8)` with edges, plus barrel `BoxGeometry(0.08, 0.08, 1.0)` offset forward at `[0, 0, -0.5]`
- All wireframe edges use cyan `lineBasicMaterial` with `toneMapped={false}`

**Props interface:**
```typescript
interface TankProps {
  onShoot?: (position: THREE.Vector3, direction: THREE.Vector3) => void;
}
```
- Expose `tankRef` via `React.forwardRef` so CameraRig can access tank position
- The turret's world-space forward direction will be needed by Plan 02 for projectile spawning

**Controls enum** (define in Tank.tsx or a shared controls file):
```typescript
enum Controls {
  forward = 'forward',
  backward = 'backward',
  left = 'left',
  right = 'right',
}
```
  </action>
  <verify>
Run `cd /Users/zacharyblevins/Desktop/tankdelete && npx tsc --noEmit` — no type errors.
Verify Tank.tsx exports Tank component with forwardRef.
Verify constants.ts exports all gameplay constants.
  </verify>
  <done>Tank component renders Tron wireframe tank, responds to WASD for body movement/rotation, turret tracks mouse position independently on Y axis. All movement is frame-rate independent (delta-time multiplied).</done>
</task>

<task type="auto">
  <name>Task 2: Create CameraRig, Crosshair, and integrate into App.tsx with KeyboardControls</name>
  <files>src/components/Scene/CameraRig.tsx, src/components/Scene/Crosshair.tsx, src/components/Scene/Scene.tsx, src/App.tsx, src/App.css</files>
  <action>
**CameraRig.tsx:**
- Receives `tankRef: React.RefObject<THREE.Group>` prop
- In useFrame: compute desired camera position as offset behind tank (CAMERA_OFFSET applied relative to tank's rotation via `applyQuaternion`)
- Smoothly lerp camera.position toward desired position at CAMERA_LERP_SPEED * delta
- For lookAt: blend between tank position (70%) and a point along turret aim direction (30%, TURRET_AIM_BLEND) for aiming feedback per user decision
- Pre-allocate all Vector3 objects with useMemo to avoid GC
- Returns null (invisible component, just manipulates camera)

**Crosshair.tsx:**
- Pure HTML overlay, NOT a 3D component
- Centered on screen with CSS: `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 100`
- Style: Tron-themed — thin cyan circle (20px diameter) with cross lines extending from it, 2px wide, color #00ffff
- Use `::before` and `::after` pseudo-elements for cross lines
- Export as React component that returns a styled div

**Scene.tsx updates:**
- Remove the hardcoded `camera` prop from Canvas (CameraRig will control camera)
- Keep `gl`, `color`, `fog` settings
- Add a default camera position as starting point: `camera={{ position: [0, 12, 20], fov: 60, near: 0.1, far: 500 }}` — CameraRig will take over on first frame
- Accept new optional prop: `tankRef` to pass down to CameraRig
- Actually, simpler approach: Scene just renders children. Tank and CameraRig will be siblings inside Scene, connected via a ref created in App.tsx.

**App.tsx updates:**
- Import `KeyboardControls` from `@react-three/drei`
- Define controls map at module level (outside component):
```typescript
const CONTROLS_MAP = [
  { name: 'forward', keys: ['KeyW', 'ArrowUp'] },
  { name: 'backward', keys: ['KeyS', 'ArrowDown'] },
  { name: 'left', keys: ['KeyA', 'ArrowLeft'] },
  { name: 'right', keys: ['KeyD', 'ArrowRight'] },
];
```
- Wrap the `<Scene>` component with `<KeyboardControls map={CONTROLS_MAP}>`. IMPORTANT: KeyboardControls must be OUTSIDE Canvas but drei's KeyboardControls works inside Canvas too. Check drei docs — actually KeyboardControls should wrap the Canvas.
- Create `tankRef = useRef<THREE.Group>(null)` in App component
- Add `<Tank ref={tankRef} />` inside Scene's children
- Add `<CameraRig tankRef={tankRef} />` inside Scene's children
- Add `<Crosshair />` OUTSIDE Scene (it's an HTML overlay, not a 3D element)
- Remove the old header with "Go up one directory" button and "Change Directory" button — these functions are now handled by portal navigation and can be added to HUD later if needed. Actually, keep the header for now but make it minimal/translucent so it doesn't block the 3D view. The header provides useful current-directory context.
- Lock pointer for immersive gameplay: Do NOT use PointerLock yet — the turret uses screen-space pointer position. PointerLock would break that. Keep pointer visible.

**App.css updates:**
- Add `.crosshair` class styles (or use inline styles in Crosshair.tsx — prefer inline for encapsulation)
  </action>
  <verify>
Run `cd /Users/zacharyblevins/Desktop/tankdelete && npx tsc --noEmit` — no type errors.
Run `cd /Users/zacharyblevins/Desktop/tankdelete && npm run build` — build succeeds.
Verify CameraRig.tsx exists and uses useFrame with lerp.
Verify App.tsx wraps Scene with KeyboardControls.
  </verify>
  <done>Third-person camera smoothly follows tank from behind and above, shifting slightly toward turret aim direction. Crosshair reticle visible at screen center. App.tsx integrates KeyboardControls wrapper, Tank, CameraRig, and Crosshair. Build passes with no errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Tank.tsx exists with useKeyboardControls, useFrame, forwardRef
4. CameraRig.tsx exists with lerp-based camera following
5. Crosshair.tsx exists with centered CSS overlay
6. constants.ts exports TANK_SPEED, TANK_ROTATION_SPEED, CAMERA_OFFSET, CAMERA_LERP_SPEED
7. App.tsx contains KeyboardControls wrapper around Scene
8. Tank component is rendered inside Scene with ref passed to CameraRig
</verification>

<success_criteria>
- Tank renders as Tron-style wireframe on the neon grid
- WASD controls move/rotate tank body with instant response (no acceleration)
- Mouse position controls turret rotation independently from body
- Camera follows behind and above tank with smooth interpolation
- Camera shifts slightly toward turret aim direction
- Crosshair is visible at screen center
- Build compiles without errors
- No GC-pressure issues (pre-allocated vectors in useFrame)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-gameplay/03-01-SUMMARY.md`
</output>
