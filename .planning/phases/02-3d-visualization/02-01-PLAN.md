---
phase: 02-3d-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/colors.ts
  - src/lib/scale.ts
  - src/lib/geometries.ts
  - src/lib/layout.ts
  - src/components/Scene/Scene.tsx
  - src/components/Scene/Grid.tsx
  - src/components/Scene/Lighting.tsx
  - src/components/Scene/PostProcessing.tsx
autonomous: true

must_haves:
  truths:
    - "A black Canvas renders with a cyan infinite neon grid floor extending to the horizon"
    - "Bloom post-processing creates visible glow halos on neon-colored test objects"
    - "Utility functions convert file sizes to log-scaled dimensions and extensions to category colors"
  artifacts:
    - path: "src/components/Scene/Scene.tsx"
      provides: "R3F Canvas wrapper with camera, background, and child composition"
      contains: "Canvas"
    - path: "src/components/Scene/Grid.tsx"
      provides: "Infinite Tron neon grid floor"
      contains: "InfiniteGridHelper"
    - path: "src/components/Scene/PostProcessing.tsx"
      provides: "Bloom + tone mapping post-processing"
      contains: "Bloom"
    - path: "src/lib/scale.ts"
      provides: "Logarithmic file size to block dimension mapping"
      contains: "fileToScale"
    - path: "src/lib/colors.ts"
      provides: "File extension to neon color mapping"
      contains: "getCategoryColor"
    - path: "src/lib/geometries.ts"
      provides: "File category to geometry shape mapping"
      contains: "FileCategory"
    - path: "src/lib/layout.ts"
      provides: "Grid-aligned row positioning for file entries"
      contains: "layoutFilesInGrid"
  key_links:
    - from: "src/components/Scene/Scene.tsx"
      to: "src/components/Scene/Grid.tsx"
      via: "JSX child component"
      pattern: "<Grid"
    - from: "src/components/Scene/Scene.tsx"
      to: "src/components/Scene/PostProcessing.tsx"
      via: "JSX child component"
      pattern: "<PostProcessing"
    - from: "src/lib/geometries.ts"
      to: "src/lib/colors.ts"
      via: "shared FileCategory type"
      pattern: "FileCategory"
---

<objective>
Install 3D dependencies and build the scene infrastructure — Canvas, Tron grid floor, lighting, bloom post-processing — plus utility modules for file-to-block mapping (scale, colors, geometries, layout).

Purpose: Establishes the visual foundation that Plan 02 will populate with actual file/folder objects. Separating scene setup from data-driven rendering keeps each plan focused and under context budget.

Output: Renderable empty Tron scene with glowing grid floor + bloom, plus all utility functions needed to transform FileEntry[] into positioned, colored, shaped blocks.
</objective>

<execution_context>
@/Users/zacharyblevins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zacharyblevins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-3d-visualization/02-RESEARCH.md
@.planning/phases/01-foundation-safety/01-01-SUMMARY.md
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install 3D dependencies and create utility modules</name>
  <files>
    package.json
    src/lib/colors.ts
    src/lib/scale.ts
    src/lib/geometries.ts
    src/lib/layout.ts
  </files>
  <action>
    **Install dependencies** (using Bun per project convention):
    ```bash
    bun add three @react-three/fiber @react-three/drei @react-three/postprocessing troika-three-text @plackyfantacky/three.infinitegridhelper
    bun add -d @types/three
    ```

    **Create `src/lib/colors.ts`:**
    - Define `FileCategory` type: `'media' | 'code' | 'archive' | 'other'`
    - Export `CATEGORY_COLORS` map — per user decision, use contrasting neon colors:
      - media: `'#00ffff'` (cyan)
      - code: `'#00ff66'` (green)
      - archive: `'#ff9900'` (orange)
      - other: `'#ff00ff'` (magenta)
    - Export `getFileCategory(extension: string | null): FileCategory` — categorize by extension:
      - media: jpg, jpeg, png, gif, webp, svg, bmp, ico, mp4, mov, avi, mkv, mp3, wav, flac, ogg, aac
      - code: ts, tsx, js, jsx, py, java, cpp, c, h, rs, go, rb, php, swift, kt, cs, txt, md, json, xml, yaml, yml, toml, html, css, scss, sql, sh, bat
      - archive: zip, tar, gz, rar, 7z, bz2, xz, dmg, iso
      - other: everything else
    - Export `getCategoryColor(extension: string | null): string` — convenience combining the two
    - Export `GRID_COLOR = '#00ffff'` and `PORTAL_COLOR = '#ff00ff'` and `BACK_PORTAL_COLOR = '#00ff66'` constants

    **Create `src/lib/scale.ts`:**
    - Export `fileToScale(sizeBytes: number): number` — logarithmic mapping
      - MIN_SCALE = 0.4, MAX_SCALE = 2.5
      - MIN_SIZE = 1024 (1 KB), MAX_SIZE = 1024^3 (1 GB)
      - Clamp input to MIN_SIZE..MAX_SIZE range
      - Apply log10 normalization: `(log10(size) - log10(min)) / (log10(max) - log10(min))`
      - Map normalized 0..1 to MIN_SCALE..MAX_SCALE
    - Export `folderToScale(childCount: number, totalSize: number): number` — for portal sizing
      - Combine child count and total size into a scale factor
      - Base scale 1.0, add 0.3 per log10(childCount), add 0.2 per log10(totalSize/1MB)
      - Clamp to 0.8..3.0 range

    **Create `src/lib/geometries.ts`:**
    - Import `FileCategory` from `./colors`
    - Export `CATEGORY_SHAPES` object mapping FileCategory to geometry config objects:
      - media: `{ type: 'box', args: [1, 0.3, 1] }` — flat panels (images/video)
      - code: `{ type: 'box', args: [0.5, 1.5, 0.5] }` — tall columns (source files)
      - archive: `{ type: 'octahedron', args: [0.6, 0] }` — diamond shape (compressed)
      - other: `{ type: 'box', args: [0.8, 0.8, 0.8] }` — cubes (default)
    - Export types: `ShapeConfig = { type: 'box' | 'octahedron'; args: number[] }`
    - Export `getShapeConfig(extension: string | null): ShapeConfig`

    **Create `src/lib/layout.ts`:**
    - Import `FileEntry` from `./types`
    - Export `BlockPosition = { x: number; y: number; z: number }`
    - Export `layoutFilesInGrid(files: FileEntry[], spacing?: number, itemsPerRow?: number): Map<string, BlockPosition>`
      - Default spacing: 3.0, default itemsPerRow: 12
      - Separate files and folders: folders get front rows, files behind
      - Sort: folders alphabetically, then files grouped by category then size descending within category (Claude's discretion: gameplay-friendly = big targets visible, similar types clustered)
      - Center each row on X axis
      - Y = 0.5 (slight float above grid)
      - Z increases per row (folders at z=0, files starting at z after folders)
      - Return Map keyed by file path
  </action>
  <verify>
    Run `bun run build` (Vite build) to confirm all imports resolve and TypeScript compiles. Also verify packages installed: `bun pm ls | grep three` shows three, @react-three/fiber, @react-three/drei, @react-three/postprocessing.
  </verify>
  <done>
    All 3D packages in node_modules, four utility modules compile without errors, each module exports the functions described above.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Scene infrastructure — Canvas, Grid, Lighting, PostProcessing</name>
  <files>
    src/components/Scene/Scene.tsx
    src/components/Scene/Grid.tsx
    src/components/Scene/Lighting.tsx
    src/components/Scene/PostProcessing.tsx
  </files>
  <action>
    Create `src/components/Scene/` directory and the following files:

    **`src/components/Scene/Grid.tsx`:**
    - Import `extend` from `@react-three/fiber` and `InfiniteGridHelper` from `@plackyfantacky/three.infinitegridhelper`
    - Call `extend({ InfiniteGridHelper })` at module level
    - Export `Grid` component that renders `<infiniteGridHelper>` with:
      - Size 1 (minor grid every 1 unit), Size 2 (major grid every 10 units)
      - Color: `new THREE.Color('#00ffff')` (cyan)
      - Distance: 150 (fade distance)
      - Axes: `'xzy'` (y-up scene)
    - If InfiniteGridHelper has TypeScript issues, add a `declare module` for it or use `// @ts-ignore`

    **`src/components/Scene/Lighting.tsx`:**
    - Export `Lighting` component with:
      - `<ambientLight intensity={0.15} />` — minimal ambient, Tron is mostly emissive
      - `<pointLight position={[0, 20, 0]} intensity={0.5} color="#4488ff" />` — subtle overhead blue tint
      - No directional lights — wireframe/emissive materials don't need them

    **`src/components/Scene/PostProcessing.tsx`:**
    - Import `EffectComposer`, `Bloom` from `@react-three/postprocessing`
    - Export `PostProcessing` component:
      ```tsx
      <EffectComposer>
        <Bloom
          intensity={2.0}
          luminanceThreshold={0.2}
          luminanceSmoothing={0.9}
          mipmapBlur
        />
      </EffectComposer>
      ```
    - Per user decision: "strong bloom" — intensity=2.0, low threshold for heavy glow halos
    - Per research: mipmapBlur for performance

    **`src/components/Scene/Scene.tsx`:**
    - Import `Canvas` from `@react-three/fiber`
    - Import `Grid`, `Lighting`, `PostProcessing` from siblings
    - Accept `children` prop (React.ReactNode) — file blocks and portals will be passed in from parent
    - Render:
      ```tsx
      <div style={{ width: '100%', height: '100%', position: 'absolute', top: 0, left: 0 }}>
        <Canvas
          camera={{ position: [0, 12, 20], fov: 60, near: 0.1, far: 500 }}
          gl={{ antialias: false, powerPreference: 'high-performance' }}
        >
          <color attach="background" args={['#050510']} />
          <fog attach="fog" args={['#050510', 50, 150]} />
          <Lighting />
          <Grid />
          {children}
          <PostProcessing />
        </Canvas>
      </div>
      ```
    - Camera: fixed third-person position looking down at grid (per ENGN-05, no movement yet)
    - Background: very dark blue-black (#050510) — per user decision "dark background"
    - Fog: subtle, per user decision "light fog" — starts at 50, ends at 150 for distant fade
    - antialias false because postprocessing handles it
    - Export as named export `Scene`
  </action>
  <verify>
    Temporarily import `Scene` in App.tsx and render `<Scene />` when state is 'ready' (just to visually confirm). Run `bun run tauri dev`. The app should show: dark background, cyan infinite grid floor with bloom glow, no errors in console. The grid should extend to the horizon with fog fade.
  </verify>
  <done>
    Scene component renders a dark Tron grid environment with cyan neon grid lines, bloom glow on the grid, fog fading to horizon, and a fixed overhead camera. All four scene modules exist and compile.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes — all TypeScript compiles, no import errors
2. `bun run tauri dev` — app launches, 'ready' state shows Tron grid scene
3. Grid lines glow with bloom effect (not flat/unlit)
4. Fog fades the grid to dark background at distance
5. Utility modules have correct exports: `fileToScale`, `getCategoryColor`, `getShapeConfig`, `layoutFilesInGrid`
</verification>

<success_criteria>
- Empty Tron scene visible with neon grid floor, bloom, and fog
- All utility modules compile and export expected functions
- All 3D dependencies installed and importable
- Scene accepts children prop for future file block rendering
</success_criteria>

<output>
After completion, create `.planning/phases/02-3d-visualization/02-01-SUMMARY.md`
</output>
