---
phase: 02-3d-visualization
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/Scene/FileBlocks.tsx
  - src/components/Scene/FolderPortal.tsx
  - src/components/Scene/BackPortal.tsx
  - src/components/Scene/Particles.tsx
  - src/hooks/useFileBlocks.ts
  - src/App.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "User sees files as glowing wireframe blocks floating above the neon grid, with shape varying by file category"
    - "Block size scales proportionally to file size using logarithmic scaling"
    - "Block colors differ by file type — cyan for media, green for code, orange for archives, magenta for other"
    - "Folders appear as glowing magenta archway portals with name, file count, and total size"
    - "A distinct green back portal exists for the parent directory"
    - "Hovering over a block shows a tooltip with full filename, exact size, and last modified date"
    - "Small floating filename labels appear above each block, color-matched to block glow"
    - "Blocks gently bob/float and pulse with a breathing glow effect"
    - "Scene maintains 60 FPS with 500+ file objects via instanced rendering"
    - "Atmospheric particles float in the scene"
  artifacts:
    - path: "src/components/Scene/FileBlocks.tsx"
      provides: "Instanced rendering of file blocks by geometry category"
      contains: "instancedMesh"
    - path: "src/components/Scene/FolderPortal.tsx"
      provides: "Glowing archway portal for folder entries"
      contains: "FolderPortal"
    - path: "src/components/Scene/BackPortal.tsx"
      provides: "Distinct parent directory portal"
      contains: "BackPortal"
    - path: "src/hooks/useFileBlocks.ts"
      provides: "Hook transforming FileEntry[] into positioned, categorized block data"
      contains: "useFileBlocks"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/Scene/Scene.tsx"
      via: "Renders Scene with file blocks as children"
      pattern: "<Scene>"
    - from: "src/hooks/useFileBlocks.ts"
      to: "src/lib/layout.ts"
      via: "Calls layoutFilesInGrid for positioning"
      pattern: "layoutFilesInGrid"
    - from: "src/hooks/useFileBlocks.ts"
      to: "src/lib/scale.ts"
      via: "Calls fileToScale for block dimensions"
      pattern: "fileToScale"
    - from: "src/components/Scene/FileBlocks.tsx"
      to: "src/hooks/useFileBlocks.ts"
      via: "Consumes block data for instanced rendering"
      pattern: "useFileBlocks"
---

<objective>
Render actual filesystem data as 3D objects — instanced file blocks grouped by category, folder portals as glowing archways, back portal for parent directory, hover tooltips, floating labels, idle animations, and atmospheric particles. Integrate the complete 3D scene into App.tsx, replacing the flat file list.

Purpose: This is the core visual delivery of Phase 2 — transforming the file list into the Tron-themed 3D visualization that users will see.

Output: Complete 3D visualization where users see their files as glowing blocks, folders as portals, with hover tooltips and 60 FPS performance.
</objective>

<execution_context>
@/Users/zacharyblevins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zacharyblevins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-3d-visualization/02-RESEARCH.md
@.planning/phases/02-3d-visualization/02-01-SUMMARY.md
@src/lib/types.ts
@src/lib/colors.ts
@src/lib/scale.ts
@src/lib/geometries.ts
@src/lib/layout.ts
@src/components/Scene/Scene.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFileBlocks hook and instanced FileBlocks component</name>
  <files>
    src/hooks/useFileBlocks.ts
    src/components/Scene/FileBlocks.tsx
  </files>
  <action>
    **Create `src/hooks/useFileBlocks.ts`:**
    - Import `FileEntry` from `../lib/types`, `layoutFilesInGrid` from `../lib/layout`, `fileToScale` from `../lib/scale`, `getFileCategory`, `getCategoryColor`, `FileCategory` from `../lib/colors`, `getShapeConfig` from `../lib/geometries`
    - Define `BlockData` type:
      ```ts
      { path: string; name: string; size: number; extension: string | null;
        position: [number, number, number]; scale: number; color: string;
        category: FileCategory; is_dir: boolean; modified?: number }
      ```
    - Export `useFileBlocks(entries: FileEntry[])` hook:
      - Use `useMemo` to compute block data from entries
      - Call `layoutFilesInGrid` for positioning (files only, not dirs)
      - For each file entry: compute scale via `fileToScale`, color via `getCategoryColor`, category via `getFileCategory`
      - Group blocks by category (for instanced rendering — each category = one InstancedMesh)
      - Return `{ blocksByCategory: Map<FileCategory, BlockData[]>, folders: FileEntry[], allBlocks: BlockData[] }`

    **Create `src/components/Scene/FileBlocks.tsx`:**
    - This is the performance-critical component — uses InstancedMesh for 500+ objects
    - Import `useRef`, `useMemo`, `useEffect`, `useState` from React
    - Import `useFrame` from `@react-three/fiber`
    - Import `Html`, `Text` from `@react-three/drei`
    - Import `THREE` from `three`
    - Import `BlockData` and types from hook
    - Import `CATEGORY_SHAPES` from `../../lib/geometries`
    - Import color constants from `../../lib/colors`

    **`InstancedCategoryBlocks` sub-component** (one per file category):
    - Props: `blocks: BlockData[]`, `shapeConfig`, `onHover: (block: BlockData | null) => void`
    - Create geometry with `useMemo` based on shapeConfig.type and args
    - Create EdgesGeometry with `useMemo` from base geometry (threshold 15 degrees)
    - Use `useRef<THREE.InstancedMesh>` for the transparent face mesh
    - Use `useRef<THREE.InstancedMesh>` for the wireframe edges mesh (separate instanced mesh for LineSegments — NOTE: InstancedMesh only works with Mesh, not LineSegments. For wireframe edges, render individual `<lineSegments>` per block BUT only for visible blocks. If performance is an issue with 500+ line segments, fall back to rendering only the transparent instanced mesh with emissive color and rely on bloom to create the wireframe look.)

    **IMPORTANT performance strategy:**
    - InstancedMesh for the solid transparent faces (1 draw call per category)
    - For wireframe edges: since LineSegments can't be instanced, use a **merged BufferGeometry** approach:
      - In a useMemo, create a single merged geometry containing all edges for all blocks in this category
      - Transform each block's EdgesGeometry by its position/scale matrix
      - Merge into one BufferGeometry using `BufferGeometryUtils.mergeGeometries()`
      - Render as single `<lineSegments>` with `<lineBasicMaterial color={categoryColor} toneMapped={false} />`
      - This gives 1 draw call for all wireframe edges per category
    - Import `mergeGeometries` from `three/examples/jsm/utils/BufferGeometryUtils.js` (or `three/addons/utils/BufferGeometryUtils.js`)

    **Per-block animations** (useFrame):
    - Gentle bob: update instanceMatrix Y positions using `sin(time * 1.5 + block.position[0] * 0.5) * 0.08`
    - Pulsing glow: modulate material emissiveIntensity with `1.0 + sin(time * 2) * 0.3`
    - For instanced mesh: update instance matrices each frame. Use a pre-allocated `tempMatrix` and `tempVector` (useMemo) to avoid GC.
    - The merged wireframe geometry needs to bob in sync — simplest: apply the bob as a group Y offset on the whole category group, so all blocks in a category bob together (slight simplification but avoids rebuilding merged geometry each frame). OR, since each category may have varied phase offsets, just re-merge is too expensive. **Decision: apply a uniform gentle bob to the entire group (`<group>` wrapping both instanced mesh and merged lines) using a single sin wave. Each category group bobs with a different phase offset based on category index.**

    **Hover detection:**
    - On the InstancedMesh (transparent faces), add `onPointerOver` and `onPointerOut` events
    - Use `event.instanceId` to identify which block was hovered
    - Call `e.stopPropagation()` to prevent event bubbling
    - Pass hovered block data up via `onHover` callback

    **Floating filename labels:**
    - Per user decision: "Small floating filename label above each block (color-matched glow to block color)"
    - Use drei's `<Text>` component for each block
    - Position above block: `[block.position.x, block.position.y + scale + 0.5, block.position.z]`
    - fontSize: 0.2, color: block.color, anchorX: "center", anchorY: "bottom"
    - outlineWidth: 0.02, outlineColor: "#000000" for readability
    - **Performance consideration:** 500+ Text components may be expensive. If needed, only render labels for blocks within a certain distance of camera. For initial implementation, render all and test performance.

    **Main `FileBlocks` export component:**
    - Props: `blocks: Map<FileCategory, BlockData[]>`, `onHover: (block: BlockData | null) => void`
    - Render one `InstancedCategoryBlocks` per category that has blocks
    - Pass onHover through

    **Hover tooltip:**
    - Track `hoveredBlock` state in this component
    - When hovered, render `<Html>` component at hovered block position:
      - Tron-styled tooltip: dark bg (rgba(5,5,16,0.95)), cyan border, monospace font
      - Show: full filename (bold), formatted file size, last modified date
      - `pointerEvents: 'none'`, `center`, `distanceFactor={10}`
      - The FileEntry type doesn't have `modified` — we'll need to check. If not available, omit modified date and note this as a gap (Phase 1 FileEntry doesn't include modified timestamp).

    NOTE: Check if `FileEntry` from types.ts includes a `modified` or `last_modified` field. If not, the tooltip will show filename and size only, and we'll note that adding modified date requires a backend change (deferred to gap closure if needed).
  </action>
  <verify>
    TypeScript compiles: `bun run build` succeeds. No runtime errors when rendering 100+ file blocks in the scene. Verify instanced rendering by checking draw call count in browser DevTools (Performance tab or Three.js inspector) — should see ~4-8 draw calls for file blocks (1 instanced mesh + 1 merged wireframe per category), not 500+.
  </verify>
  <done>
    File blocks render as glowing wireframe shapes grouped by category using instanced rendering. Each category has its distinct geometry (flat panels, tall columns, diamonds, cubes). Blocks have transparent faces with glowing wireframe edges. Floating filename labels appear above each block. Hovering shows a styled tooltip with file details. Gentle bob animation and pulsing glow are visible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FolderPortal, BackPortal, Particles, and integrate into App.tsx</name>
  <files>
    src/components/Scene/FolderPortal.tsx
    src/components/Scene/BackPortal.tsx
    src/components/Scene/Particles.tsx
    src/App.tsx
    src/App.css
  </files>
  <action>
    **Create `src/components/Scene/FolderPortal.tsx`:**
    - Per user decision: "Glowing archway/gate design — tall neon arch with clear walk-through-me affordance"
    - Props: `folder: FileEntry`, `position: [number, number, number]`, `scale: number`, `childCount: number`, `totalSize: number`, `onClick: () => void`, `onHover: (data: any | null) => void`
    - Build archway geometry:
      - Two vertical pillars: BoxGeometry(0.15, height, 0.15) at +-archWidth/2
      - Top arch: TorusGeometry(archWidth/2, 0.08, 8, 32, Math.PI) rotated to sit on top of pillars
      - All rendered as wireframe (EdgesGeometry + lineSegments) with `toneMapped={false}`
      - Color: PORTAL_COLOR (`#ff00ff` magenta) from colors.ts
    - Per user decision: "Portal size scales by folder contents — bigger folders get bigger, more imposing portals"
      - Use `folderToScale` from scale.ts for the scale prop
    - Floating text above portal (drei Text):
      - Folder name (larger, color-matched magenta)
      - "{childCount} items - {formatBytes(totalSize)}" (smaller, cyan)
    - Idle animation: subtle pulsing glow on material emissiveIntensity via useFrame
    - onClick handler for navigation (passed from parent)
    - onPointerOver/Out for hover state — brighten portal on hover (increase emissive)

    **Create `src/components/Scene/BackPortal.tsx`:**
    - Per user decision: "Distinct back portal for parent directory — different color/shape from regular folder portals"
    - Same archway structure as FolderPortal but:
      - Color: BACK_PORTAL_COLOR (`#00ff66` green)
      - Label: "← BACK" with parent directory name below
      - Slightly smaller default scale (0.8)
      - Positioned at the back of the scene (negative Z, behind all other objects)
    - Props: `parentPath: string`, `onClick: () => void`

    **Create `src/components/Scene/Particles.tsx`:**
    - Per user decision: "subtle floating particles"
    - Create 80 small particles (conservative count per research open question)
    - Use InstancedMesh with tiny SphereGeometry(0.02, 4, 4)
    - Material: emissive cyan, toneMapped={false}, transparent, opacity 0.6
    - Scatter in a large volume: X +-30, Y 0.5-8, Z +-30
    - useFrame: gentle upward drift + sine wave horizontal wander
    - When particle Y > 8, reset to Y = 0.5 with random X/Z
    - Very subtle — just ambient atmosphere, not distracting

    **Integrate into `src/App.tsx`:**
    - Import `Scene` from `./components/Scene/Scene`
    - Import `FileBlocks` from `./components/Scene/FileBlocks`
    - Import `FolderPortal` from `./components/Scene/FolderPortal`
    - Import `BackPortal` from `./components/Scene/BackPortal`
    - Import `Particles` from `./components/Scene/Particles`
    - Import `useFileBlocks` from `./hooks/useFileBlocks`
    - Import `layoutFilesInGrid` from `./lib/layout`
    - Import `folderToScale` from `./lib/scale`

    - In the `ready` state rendering:
      - Replace the flat `<div className="file-list">` with the 3D scene
      - Call `useFileBlocks(entries)` to get `blocksByCategory`, `folders`, `allBlocks`
      - Compute folder positions from layout (folders get front rows)
      - Render:
        ```tsx
        <Scene>
          <FileBlocks blocks={blocksByCategory} onHover={setHoveredBlock} />
          {folders.map(folder => (
            <FolderPortal
              key={folder.path}
              folder={folder}
              position={folderPositions.get(folder.path)}
              scale={folderToScale(folder.childCount, folder.size)}
              childCount={/* from entries */}
              totalSize={folder.size}
              onClick={() => navigateToDirectory(folder.path)}
              onHover={...}
            />
          ))}
          {currentDirectory !== '/' && (
            <BackPortal parentPath={parentPath} onClick={navigateUp} />
          )}
          <Particles />
        </Scene>
        ```
      - Keep HUD overlay on top of the 3D scene (position: absolute, z-index above canvas)
      - Keep Toaster on top as well
      - Keep header bar with current directory path and "Change Directory" button
      - Style adjustments in App.css: make the ready state fill the viewport, header as overlay on top of 3D scene

    - **Note on folder child counts:** The current `FileEntry` has `size` for folders (computed recursively in Phase 1) but may not have a `child_count`. Compute child counts from the entries array: for each folder, count how many entries have that folder's path as a parent. If this is insufficient (only shows immediate children in current scan), use the count of direct children visible in the entries list.

    **Update `src/App.css`:**
    - The 'ready' state needs to be full viewport for the 3D scene
    - Header bar: position absolute/fixed, top, z-index above canvas, semi-transparent dark background
    - HUD: already position fixed, just ensure z-index is above canvas
    - Remove or hide the flat file-list styles (no longer used in ready state)
    - Add `.scene-container` class: `position: relative; width: 100%; height: 100vh; overflow: hidden;`
  </action>
  <verify>
    Run `bun run tauri dev`. Select a directory with files and folders. Verify:
    1. Files appear as glowing wireframe blocks on the grid (different shapes per type)
    2. Block sizes vary (large files = bigger blocks)
    3. Colors differ by file type
    4. Folders appear as magenta archway portals with name/count labels
    5. Back portal (green) visible if not at root
    6. Hovering a block shows tooltip
    7. Floating particles visible in atmosphere
    8. HUD overlay visible on top of 3D scene
    9. "Change Directory" button accessible
    10. Clicking a folder portal navigates into that directory (scene refreshes)
    11. Performance: scene feels smooth (not obviously janky)
  </verify>
  <done>
    Complete 3D visualization renders filesystem data: file blocks as instanced wireframe shapes, folder portals as magenta archways, green back portal, floating particles. All interactive: hover tooltips, portal click navigation. HUD and controls overlay the 3D scene. App transitions from flat list to immersive Tron environment.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of Tron 3D scene</name>
  <files>src/App.tsx</files>
  <action>
    Human verification checkpoint — no code changes. Verify the complete Phase 2 3D visualization:
    files as glowing wireframe blocks on a Tron neon grid, folders as magenta portal archways,
    bloom post-processing, floating particles, hover tooltips, and interactive folder navigation —
    all rendering actual filesystem data.

    Steps:
    1. Launch the app: `bun run tauri dev`
    2. Select a directory with a mix of files and folders (ideally 50+ files for visual impact)

    **Check Tron Aesthetic (VIZL-05):**
    - Dark background with cyan neon grid floor extending to horizon
    - Grid lines glow with bloom (not flat/thin)
    - Light fog fading scene to darkness at distance
    - Subtle floating particles in the atmosphere

    **Check File Blocks (VIZL-01, VIZL-02, VIZL-03):**
    - Files appear as glowing wireframe shapes (transparent faces, glowing edges)
    - Different shapes visible: flat panels (images), tall columns (code), diamonds (archives), cubes (other)
    - Block sizes vary — larger files have bigger blocks
    - Colors vary by type: cyan (media), green (code), orange (archives), magenta (other)
    - Blocks gently bob/float above the grid
    - Blocks have subtle pulsing glow (breathing effect)
    - Small filename labels float above each block

    **Check Folder Portals (VIZL-06):**
    - Folders appear as magenta glowing archway structures
    - Portal shows folder name and item count
    - Bigger folders have bigger portals
    - A green "BACK" portal exists for parent directory

    **Check Interactivity (VIZL-04):**
    - Hovering over a file block shows tooltip with filename and size
    - Clicking a folder portal navigates into that directory (scene reloads)
    - HUD overlay visible showing session stats
    - "Change Directory" button accessible

    **Check Performance (ENGN-06):**
    - Navigate to a directory with 100+ files — scene should feel smooth (60 FPS)
    - No obvious lag or stuttering during idle animations
  </action>
  <verify>User confirms visual checklist above passes or reports issues</verify>
  <done>User types "approved" — Phase 2 visual verification complete</done>
</task>

</tasks>

<verification>
Phase 2 success criteria from ROADMAP.md:
1. ✅ User sees files as glowing geometric blocks on a dark neon grid
2. ✅ Block size scales proportionally to file size (larger files = larger blocks)
3. ✅ Block colors vary by file type/extension
4. ✅ Folders appear as distinct portal/gate structures
5. ✅ Scene maintains 60 FPS with 500+ file objects visible (instanced rendering)
6. ✅ User can hover over a block and see tooltip with filename, size, and last modified date
7. ✅ Camera follows a fixed position in third-person view (no movement yet)
8. ✅ Tron aesthetic visible: neon grid floor, glowing wireframe edges, bloom post-processing
</verification>

<success_criteria>
- Files render as glowing wireframe blocks with category-based shapes and colors
- Block size scales logarithmically with file size
- Folders render as magenta archway portals with name/count labels
- Green back portal for parent directory navigation
- Hover tooltip shows file details
- Floating filename labels above each block
- Gentle bob animation and pulsing glow on all blocks
- Atmospheric particles floating in scene
- Strong bloom post-processing with neon glow halos
- Scene integrates with existing App.tsx state machine and navigation
- Performance: 60 FPS with 500+ objects via instanced rendering
</success_criteria>

<output>
After completion, create `.planning/phases/02-3d-visualization/02-02-SUMMARY.md`
</output>
