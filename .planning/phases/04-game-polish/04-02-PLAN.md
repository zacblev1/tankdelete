---
phase: 04-game-polish
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/App.tsx
  - src/components/HUD.tsx
  - src/components/HUD.css
autonomous: false

must_haves:
  truths:
    - "User earns points based on MB freed when deleting files, visible in HUD score counter"
    - "Score counter in top-right updates in real-time with counting animation on each deletion"
    - "Particle explosion plays on file deletion with color matching file category"
    - "Large files produce massive explosions, small files produce small puffs"
    - "Batch delete triggers staggered explosions 80ms apart for chain reaction feel"
    - "Achievement toast appears when 100MB, 1GB, or 10GB thresholds crossed"
    - "Score persists across directory navigation within session"
  artifacts:
    - path: "src/App.tsx"
      provides: "Full integration of score, achievements, and explosions into deletion flow"
      contains: "useScore"
    - path: "src/components/HUD.tsx"
      provides: "Enhanced HUD with score counter replacing raw stats"
      contains: "ScoreCounter"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useScore.ts"
      via: "useScore hook in App component"
      pattern: "useScore\\(\\)"
    - from: "src/App.tsx"
      to: "src/hooks/useAchievements.ts"
      via: "useAchievements hook tracking totalBytesFreed"
      pattern: "useAchievements\\("
    - from: "src/App.tsx"
      to: "src/hooks/useExplosionPool.ts"
      via: "useExplosionPool hook for spawn/despawn"
      pattern: "useExplosionPool\\(\\)"
    - from: "src/App.tsx handleProjectileHit"
      to: "spawnExplosion"
      via: "spawn explosion on second hit (file deletion)"
      pattern: "spawnExplosion.*position.*color"
    - from: "src/App.tsx handleBatchDelete"
      to: "spawnExplosion with setTimeout"
      via: "staggered 80ms explosions for chain reaction"
      pattern: "setTimeout.*spawnExplosion.*80"
    - from: "src/App.tsx"
      to: "ExplosionParticles component"
      via: "rendered inside Scene with explosions prop"
      pattern: "ExplosionParticles.*explosions"
---

<objective>
Wire scoring, achievements, and explosion particles into App.tsx and enhance the HUD.

Purpose: Connect all Plan 01 artifacts to the existing deletion flow so users experience gamification feedback when deleting files.
Output: Modified App.tsx with full integration, enhanced HUD.tsx with score counter.
</objective>

<execution_context>
@/Users/zacharyblevins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zacharyblevins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-game-polish/04-RESEARCH.md
@.planning/phases/04-game-polish/04-01-SUMMARY.md

@src/App.tsx
@src/components/HUD.tsx
@src/components/HUD.css
@src/hooks/useFileBlocks.ts
@src/lib/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate score, achievements, and explosions into App.tsx</name>
  <files>
    src/App.tsx
    src/components/HUD.tsx
    src/components/HUD.css
  </files>
  <action>
    Wire all Plan 01 artifacts into the existing App component and enhance the HUD:

    **src/App.tsx modifications:**

    1. Add imports:
       - `import { useScore } from './hooks/useScore'`
       - `import { useAchievements } from './hooks/useAchievements'`
       - `import { useExplosionPool } from './hooks/useExplosionPool'`
       - `import { ExplosionParticles } from './components/Scene/ExplosionParticles'`

    2. Add hooks in App function (after existing hooks):
       - `const { score, totalBytesFreed, addPoints } = useScore()`
       - `const { earned } = useAchievements(totalBytesFreed)`
       - `const { explosions, spawn: spawnExplosion, despawn: despawnExplosion } = useExplosionPool()`

    3. Modify `handleProjectileHit` - when second hit deletes file:
       - After `commands.moveToTrash(filePath)` succeeds, call `addPoints(action.original_size)` to add score
       - Find the block: `const block = allBlocks.find(b => b.path === filePath)`
       - If block found, spawn explosion: `spawnExplosion(new THREE.Vector3(...block.position), block.color, block.scale)`
       - Update toast message to include points: `Deleted ${action.file_name} (+${points} pts)`

    4. Modify `handleBatchDelete`:
       - BEFORE calling `deleteAllMarked()`, capture the file list and their block data
       - Stagger explosions with setTimeout: `filesToDelete.forEach((filePath, index) => { setTimeout(() => { const block = allBlocks.find(b => b.path === filePath); if (block) spawnExplosion(new THREE.Vector3(...block.position), block.color, block.scale); }, index * 80); })`
       - After deleteAllMarked completes and session stats update, calculate points from bytes difference and call addPoints
       - The 80ms stagger per user decision creates chain reaction feel

    5. Pass score to HUD: `<HUD deletedCount={deletedCount} deletedBytes={deletedBytes} score={score} />`

    6. Add ExplosionParticles inside Scene (after ProjectileManager, before FileBlocks):
       `<ExplosionParticles explosions={explosions} onExplosionComplete={despawnExplosion} />`

    **src/components/HUD.tsx modifications:**
    - Add `score: number` to HUDProps interface
    - Import ScoreCounter: `import { ScoreCounter } from './HUD/ScoreCounter'`
    - Replace the existing HUD content with an enhanced layout:
      - Keep the existing stats (files deleted, bytes freed) in a secondary row
      - Add ScoreCounter as the prominent element: `<ScoreCounter targetScore={score} />`
    - Change visibility logic: show HUD when score > 0 OR deletedCount > 0 (score starts at 0 so first deletion triggers both)
    - The ScoreCounter has its own fixed positioning (top-right), so the existing HUD stats should move to accommodate. Position the stats row below the score counter (top: 90px instead of 20px).

    **src/components/HUD.css modifications:**
    - Update `.hud` top position to 90px to sit below ScoreCounter
    - Keep existing styling (dark bg, cyan border, neon glow)

    IMPORTANT: Do NOT add combo/streak mechanics (user decision: "no combo or streak mechanics"). Score is purely MB-based. Do NOT add floating in-world score numbers (user decision: "Score displayed in HUD counter only").
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify App.tsx compiles with all new imports and hook usage. Run `bun run dev` (or `npm run dev`) and verify the app starts without runtime errors.
  </verify>
  <done>
    App.tsx imports and uses useScore, useAchievements, useExplosionPool. handleProjectileHit spawns explosion and adds score on deletion. handleBatchDelete staggers explosions 80ms apart. ScoreCounter visible in top-right. ExplosionParticles rendered in Scene. HUD shows stats below score.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify game polish visuals and gameplay feel</name>
  <files>src/App.tsx</files>
  <action>
    User visually verifies the complete gamification system is working correctly. All automation is complete in Task 1 - this checkpoint confirms the visual and gameplay feel meets expectations.
  </action>
  <verify>
    User confirms all 9 verification steps below pass:
    1. Run `bun run dev` (or `npm run dev`) and launch the Tauri app
    2. Select a directory with files of varying sizes
    3. Score counter: Verify score display appears in top-right with Tron neon styling (cyan border, glow)
    4. Single deletion: Shoot a file twice (mark then delete). Verify particle explosion spawns at file location with cubes scattering outward, explosion color matches file category, score counter ticks up, existing de-rez animation still plays
    5. Small vs large file: Delete a small file and a large file. Verify large file produces significantly bigger explosion
    6. Batch delete: Mark 3+ files, press Delete/X. Verify explosions trigger in rapid sequence (chain reaction), not all at once
    7. Achievement: If you can accumulate 100MB+ of deletions, verify "Derezzer" achievement toast slides in from top with Tron styling
    8. Navigation: Enter a folder portal, verify score persists (does not reset)
    9. HUD layout: Verify score counter and file stats don't overlap, both readable
  </verify>
  <done>User types "approved" confirming visuals, timing, and gameplay feel are satisfactory.</done>
</task>

</tasks>

<verification>
- Score increments correctly: 1 point per MB freed (Math.floor)
- Score counter animates smoothly without jumping
- Explosions spawn at correct positions with correct category colors
- Batch delete creates staggered chain reaction (80ms spacing)
- Achievement toasts appear at threshold crossings
- No performance degradation with multiple simultaneous explosions
- Score persists across directory navigation
- All existing functionality (tank, shooting, portals, minimap) still works
</verification>

<success_criteria>
- Deleting a 500MB file adds 500 to score, visible in animated counter
- Explosion particles are colored cubes matching file category
- Batch deleting 5 files shows 5 sequential explosions over ~400ms
- Achievement "Derezzer" toast appears after freeing 100MB total
- Score does not reset when navigating directories
- App maintains 60fps during normal gameplay with occasional explosions
</success_criteria>

<output>
After completion, create `.planning/phases/04-game-polish/04-02-SUMMARY.md`
</output>
